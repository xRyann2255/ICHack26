FoamFile
{
    version     2.0;
    format      ascii;
    class       dictionary;
    object      snappyHexMeshDict;
}

castellatedMesh true;
snap            true;
addLayers       false;  // enable later if needed

geometry
{
    southken.stl
    {
        type triSurfaceMesh;
        name buildings;
    }
}

castellatedMeshControls
{
    maxLocalCells       1000000;
    maxGlobalCells      10000000;
    minRefinementCells  10;
    maxLoadUnbalance    0.10;
    nCellsBetweenLevels 3;
    
    features
    (
        {
            file "buildings.eMesh";
            level 2;
        }
    );
    
    refinementSurfaces
    {
        buildings
        {
            level (2 3);    // min max refinement at surface
            patchInfo
            {
                type wall;
            }
        }
    }
    
    resolveFeatureAngle 30;
    
    refinementRegions
    {
        // Optional: refine a box around the area of interest
        // refinementBox
        // {
        //     mode inside;
        //     levels ((1e15 2));
        // }
    }
    
    // CRITICAL: point inside the fluid domain, outside all buildings
    // Pick a point clearly in open air
    locationInMesh (-1700 -1900 50);
    
    allowFreeStandingZoneFaces true;
}

snapControls
{
    nSmoothPatch            3;
    tolerance               2.0;
    nSolveIter              50;
    nRelaxIter              5;
    nFeatureSnapIter        10;
    implicitFeatureSnap     false;
    explicitFeatureSnap     true;
    multiRegionFeatureSnap  false;
}

addLayersControls
{
    relativeSizes           true;
    layers
    {
        buildings
        {
            nSurfaceLayers  3;
        }
    }
    expansionRatio          1.2;
    finalLayerThickness     0.5;
    minThickness            0.1;
    nGrow                   0;
    featureAngle            180;
    nRelaxIter              5;
    nSmoothSurfaceNormals   1;
    nSmoothNormals          3;
    nSmoothThickness        10;
    maxFaceThicknessRatio   0.5;
    maxThicknessToMedialRatio 0.3;
    minMedialAxisAngle      90;
    nBufferCellsNoExtrude   0;
    nLayerIter              50;
}

meshQualityControls
{
    maxNonOrtho             65;
    maxBoundarySkewness     20;
    maxInternalSkewness     4;
    maxConcave              80;
    minVol                  1e-13;
    minTetQuality           1e-30;
    minArea                 -1;
    minTwist                0.02;
    minDeterminant          0.001;
    minFaceWeight           0.02;
    minVolRatio             0.01;
    minTriangleTwist        -1;
    nSmoothScale            4;
    errorReduction          0.75;
}

mergeTolerance 1e-6;
